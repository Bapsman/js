/**
 * Thundr.com Text Chat Automation Script
 * Paste this into the browser console on https://thundr.com/text
 *
 * Flow: type message -> send -> skip to new chat -> wait for next -> repeat
 * GUI: Start/Stop + editable message box + settings
 */

(function () {
  // ========== CONFIG ==========
  const FALLBACK_MESSAGE = "";

  // Delays in ms — these are defaults; GUI sliders override them at runtime
  let DELAY_AFTER_INPUT_MS = 600;
  let DELAY_AFTER_SEND = 800;
  let DELAY_AFTER_SKIP = 2000;
  let WAIT_FOR_NEXT_USER_MS = 5000;
  const WAIT_FOR_CHAT_READY_MS = 60000;
  const WAIT_FOR_SEND_ENABLED_MS = 2500;
  const POLL_INTERVAL = 500;

  let stopRequested = false;
  let guiMessageEl = null;
  let guiRepeatEl = null;
  let sentCount = 0;

  const GUI_ID = "thundr-auto-gui";

  function looksLikeScript(text) {
    if (!text || typeof text !== "string") return true;
    const t = text.trim();
    if (t.length > 2000) return true;
    if (/\b(function|=>|const |let |var |startThundrAuto|ThundrAuto|FALLBACK_MESSAGE)\b/.test(t)) return true;
    if (t.includes("(function ()") && t.includes("})();")) return true;
    return false;
  }

  function log(msg) {
    console.log("[ThundrAuto]", msg);
  }

  function findByText(text) {
    const gui = document.getElementById(GUI_ID);
    const nodes = document.querySelectorAll("button, a, [role='button'], input[type='submit']");
    for (const el of nodes) {
      if (gui && gui.contains(el)) continue;
      if (el.textContent && el.textContent.trim().toLowerCase().includes((text || "").toLowerCase()))
        return el;
    }
    return null;
  }

  function getMessageInput() {
    const gui = document.getElementById(GUI_ID);
    // Try placeholder-based selectors first (thundr uses "Write a message...")
    const byPlaceholder = document.querySelector('input[placeholder*="Write a message"], input[placeholder*="message"], textarea[placeholder*="Write a message"], textarea[placeholder*="message"]');
    if (byPlaceholder && !(gui && gui.contains(byPlaceholder))) return byPlaceholder;
    // Fallback to generic, excluding our GUI
    const allInputs = document.querySelectorAll("textarea, input[type='text']");
    for (const el of allInputs) {
      if (gui && gui.contains(el)) continue;
      return el;
    }
    return null;
  }

  function getSendButton() {
    return findByText("Send") || document.querySelector("button[type='submit']");
  }

  function getSkipButton() {
    // Thundr uses "New Chat" after disconnect, and "Start" (Esc) to begin/skip
    return findByText("New Chat")
      || findByText("Start")
      || findByText("Skip")
      || findByText("Next");
  }

  function getMessageToSend() {
    if (guiMessageEl) {
      const val = (guiMessageEl.value || "").trim();
      if (val && !looksLikeScript(val)) return val;
    }
    return FALLBACK_MESSAGE;
  }

  function sleep(ms) {
    return new Promise((r) => setTimeout(r, ms));
  }

  function setInputValueReactFriendly(input, value) {
    input.focus();
    const proto = input instanceof HTMLTextAreaElement
      ? window.HTMLTextAreaElement.prototype
      : window.HTMLInputElement.prototype;
    const setter = Object.getOwnPropertyDescriptor(proto, "value");
    if (setter && setter.set) {
      setter.set.call(input, value);
    } else {
      input.value = value;
    }
    input.dispatchEvent(new InputEvent("input", { bubbles: true, data: value, inputType: "insertText" }));
    input.dispatchEvent(new Event("change", { bubbles: true }));
  }

  function dispatchEnterKey(input) {
    const opts = { key: "Enter", code: "Enter", keyCode: 13, which: 13, bubbles: true };
    input.dispatchEvent(new KeyboardEvent("keydown", opts));
    input.dispatchEvent(new KeyboardEvent("keypress", opts));
    input.dispatchEvent(new KeyboardEvent("keyup", opts));
  }

  function dispatchEscKey() {
    const opts = { key: "Escape", code: "Escape", keyCode: 27, which: 27, bubbles: true };
    document.dispatchEvent(new KeyboardEvent("keydown", opts));
    document.dispatchEvent(new KeyboardEvent("keyup", opts));
  }

  function needsStartPress() {
    const text = document.body.textContent || "";
    return text.includes("Press start to continue") || text.includes("press start");
  }

  function autoClickStart() {
    if (!needsStartPress()) return false;
    const gui = document.getElementById(GUI_ID);

    // Try findByText first (buttons only)
    const btn = findByText("Start");
    if (btn) {
      btn.click();
      log("Auto-pressed Start button (site requested it).");
      return true;
    }

    // Broader search: any element containing "Start" text (divs, spans, etc.)
    const allEls = document.querySelectorAll("*");
    for (const el of allEls) {
      if (gui && gui.contains(el)) continue;
      if (el.children.length > 2) continue; // skip containers, target leaf-ish elements
      const t = (el.textContent || "").trim();
      if (t === "Start" || t === "Start\nEsc" || t.startsWith("Start")) {
        if (el.tagName === "SCRIPT" || el.tagName === "STYLE") continue;
        el.click();
        log("Auto-clicked Start element (site requested it).");
        return true;
      }
    }

    // Last resort: press Escape key (thundr binds Esc to Start)
    dispatchEscKey();
    log("Auto-pressed Escape for Start (site requested it).");
    return true;
  }

  function isChatActive() {
    const text = document.body.textContent || "";
    if (text.includes("disconnected")) return false;
    if (needsStartPress()) return false;
    if (text.includes("now chatting")) return true;
    return false;
  }

  function waitForChatReady(maxWaitMs) {
    return new Promise((resolve) => {
      const start = Date.now();
      const check = () => {
        if (stopRequested) return resolve(false);
        autoClickStart();
        const input = getMessageInput();
        const hasInput = input && !input.disabled;
        if (hasInput && isChatActive()) {
          log("Chat ready. Starting send/skip loop.");
          return resolve(true);
        }
        if (Date.now() - start >= maxWaitMs) {
          log("Timeout waiting for chat. Start a chat first, then run the script.");
          return resolve(false);
        }
        setTimeout(check, POLL_INTERVAL);
      };
      check();
    });
  }

  function waitForNextUser(maxWaitMs) {
    return new Promise((resolve) => {
      const start = Date.now();
      const check = () => {
        if (stopRequested) return resolve(false);
        autoClickStart();
        if (isChatActive()) {
          const input = getMessageInput();
          if (input && !input.disabled) return resolve(true);
        }
        if (Date.now() - start >= maxWaitMs) return resolve(false);
        setTimeout(check, POLL_INTERVAL);
      };
      check();
    });
  }

  async function sendAndSkip() {
    // Handle "Press start to continue" prompt before trying to send
    if (autoClickStart()) {
      await sleep(1500);
      return false; // let the loop re-check for a connected stranger
    }

    if (!isChatActive()) return false;

    const input = getMessageInput();
    if (!input) {
      log("Message input not found. Waiting...");
      return false;
    }

    const msg = getMessageToSend();
    if (!msg) {
      log("No message. Set FALLBACK_MESSAGE in the script.");
      return false;
    }

    log('Sending: "' + msg.substring(0, 50) + (msg.length > 50 ? "..." : "") + '"');
    setInputValueReactFriendly(input, msg);
    await sleep(DELAY_AFTER_INPUT_MS);

    // Try clicking Send, fall back to Enter key
    const sendDeadline = Date.now() + WAIT_FOR_SEND_ENABLED_MS;
    let sendBtn = getSendButton();
    while (sendBtn && sendBtn.disabled && Date.now() < sendDeadline) {
      await sleep(100);
      sendBtn = getSendButton();
    }
    if (sendBtn && !sendBtn.disabled) {
      sendBtn.click();
    } else {
      dispatchEnterKey(input);
    }

    sentCount++;
    updateCounter();
    log("Sent #" + sentCount);

    await sleep(DELAY_AFTER_SEND);

    // Skip: first click disconnects, second click starts new chat
    const skipBtn = getSkipButton();
    if (skipBtn) {
      skipBtn.click();
      log("Clicked disconnect (1/2)...");
    } else {
      dispatchEscKey();
      log("Pressed Escape to disconnect (1/2)...");
    }

    // Wait for the button to update, then click again to start new chat
    await sleep(800);
    const newChatBtn = getSkipButton();
    if (newChatBtn) {
      newChatBtn.click();
      log("Clicked new chat (2/2). Waiting for next user...");
    } else {
      dispatchEscKey();
      log("Pressed Escape for new chat (2/2). Waiting for next user...");
    }

    await sleep(DELAY_AFTER_SKIP);
    return true;
  }

  function updateCounter() {
    const el = document.querySelector("#thundr-auto-counter");
    if (el) el.textContent = "Sent: " + sentCount;
  }

  function resetGuiButtons() {
    const startBtn = document.querySelector("#thundr-auto-start");
    const stopBtn = document.querySelector("#thundr-auto-stop");
    if (startBtn) startBtn.disabled = false;
    if (stopBtn) stopBtn.disabled = true;
  }

  async function runLoop() {
    log("Started. Use Stop button or run stopThundrAuto() in console.");
    stopRequested = false;

    const ready = await waitForChatReady(WAIT_FOR_CHAT_READY_MS);
    if (!ready || stopRequested) {
      resetGuiButtons();
      return;
    }

    while (!stopRequested) {
      const ok = await sendAndSkip();
      if (!ok) {
        await sleep(POLL_INTERVAL);
        continue;
      }
      if (guiRepeatEl && !guiRepeatEl.checked) {
        log("Repeat is off. Finished one cycle.");
        break;
      }
      const found = await waitForNextUser(WAIT_FOR_NEXT_USER_MS);
      if (!found && !stopRequested) await sleep(POLL_INTERVAL);
    }
    log("Stopped.");
    resetGuiButtons();
  }

  window.stopThundrAuto = function () {
    stopRequested = true;
    log("Stop requested.");
  };

  window.startThundrAuto = function () {
    runLoop();
  };

  function createGUI() {
    const existing = document.getElementById(GUI_ID);
    if (existing) existing.remove();

    const panel = document.createElement("div");
    panel.id = GUI_ID;
    panel.innerHTML = `
      <style>
        #${GUI_ID} {
          position: fixed;
          top: 12px;
          right: 12px;
          width: 280px;
          background: linear-gradient(145deg, #1a1a1a 0%, #2a2a2a 100%);
          border: 1px solid #444;
          border-radius: 10px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.5);
          font-family: system-ui, -apple-system, sans-serif;
          font-size: 13px;
          color: #e8e8e8;
          z-index: 999999;
          user-select: none;
        }
        #${GUI_ID} .gui-header {
          padding: 10px 12px;
          background: rgba(50,50,50,0.6);
          border-radius: 10px 10px 0 0;
          cursor: move;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 6px;
        }
        #${GUI_ID} .gui-header::before { content: "⚡"; }
        #${GUI_ID} .gui-counter {
          margin-left: auto;
          background: #111;
          padding: 2px 8px;
          border-radius: 10px;
          font-size: 11px;
          color: #f5c518;
          font-weight: 600;
          letter-spacing: 0.3px;
        }
        #${GUI_ID} .gui-tabs {
          display: flex;
          border-bottom: 1px solid #444;
        }
        #${GUI_ID} .gui-tab {
          flex: 1;
          padding: 8px 0;
          text-align: center;
          font-size: 12px;
          font-weight: 600;
          color: #777;
          cursor: pointer;
          border: none;
          background: none;
          border-bottom: 2px solid transparent;
          transition: color 0.2s, border-color 0.2s;
        }
        #${GUI_ID} .gui-tab:hover { color: #c0c0c0; }
        #${GUI_ID} .gui-tab.active {
          color: #e8e8e8;
          border-bottom-color: #f5c518;
        }
        #${GUI_ID} .gui-page { display: none; padding: 12px; }
        #${GUI_ID} .gui-page.active { display: block; }
        #${GUI_ID} label {
          display: block;
          margin-bottom: 4px;
          font-size: 11px;
          color: #a0a0a0;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        #${GUI_ID} textarea {
          width: 100%;
          min-height: 72px;
          padding: 8px 10px;
          margin-bottom: 10px;
          box-sizing: border-box;
          background: #111;
          border: 1px solid #333;
          border-radius: 6px;
          color: #e8e8e8;
          font-family: inherit;
          font-size: 13px;
          resize: vertical;
        }
        #${GUI_ID} textarea:focus {
          outline: none;
          border-color: #f5c518;
        }
        #${GUI_ID} .gui-buttons {
          display: flex;
          gap: 8px;
        }
        #${GUI_ID} button.btn-start, #${GUI_ID} button.btn-stop {
          flex: 1;
          padding: 10px 14px;
          border: none;
          border-radius: 6px;
          font-weight: 600;
          font-size: 13px;
          cursor: pointer;
          transition: transform 0.1s, opacity 0.2s;
        }
        #${GUI_ID} button:active { transform: scale(0.98); }
        #${GUI_ID} button:disabled { opacity: 0.5; cursor: not-allowed; }
        #${GUI_ID} .btn-start {
          background: linear-gradient(135deg, #f5c518 0%, #f0a000 100%);
          color: #111;
        }
        #${GUI_ID} .btn-stop {
          background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
          color: #fff;
        }
        #${GUI_ID} .gui-toggle {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 10px;
        }
        #${GUI_ID} .gui-toggle span {
          font-size: 12px;
          color: #c0c0c0;
        }
        #${GUI_ID} .toggle-switch {
          position: relative;
          width: 40px;
          height: 22px;
          flex-shrink: 0;
        }
        #${GUI_ID} .toggle-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        #${GUI_ID} .toggle-slider {
          position: absolute;
          cursor: pointer;
          top: 0; left: 0; right: 0; bottom: 0;
          background: #333;
          border-radius: 22px;
          transition: background 0.2s;
        }
        #${GUI_ID} .toggle-slider::before {
          content: "";
          position: absolute;
          height: 16px;
          width: 16px;
          left: 3px;
          bottom: 3px;
          background: #a0a0a0;
          border-radius: 50%;
          transition: transform 0.2s, background 0.2s;
        }
        #${GUI_ID} .toggle-switch input:checked + .toggle-slider {
          background: #f5c518;
        }
        #${GUI_ID} .toggle-switch input:checked + .toggle-slider::before {
          transform: translateX(18px);
          background: #111;
        }
        #${GUI_ID} .slider-row {
          margin-bottom: 12px;
        }
        #${GUI_ID} .slider-label {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 4px;
        }
        #${GUI_ID} .slider-label span {
          font-size: 12px;
          color: #c0c0c0;
        }
        #${GUI_ID} .slider-label .slider-val {
          font-size: 11px;
          color: #f5c518;
          font-weight: 600;
          min-width: 42px;
          text-align: right;
        }
        #${GUI_ID} input[type="range"] {
          -webkit-appearance: none;
          appearance: none;
          width: 100%;
          height: 6px;
          background: #333;
          border-radius: 3px;
          outline: none;
          cursor: pointer;
        }
        #${GUI_ID} input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 16px;
          height: 16px;
          border-radius: 50%;
          background: #f5c518;
          cursor: pointer;
          border: 2px solid #111;
        }
        #${GUI_ID} input[type="range"]::-moz-range-thumb {
          width: 16px;
          height: 16px;
          border-radius: 50%;
          background: #f5c518;
          cursor: pointer;
          border: 2px solid #111;
        }
      </style>
      <div class="gui-header">Thundr Auto<span class="gui-counter" id="thundr-auto-counter">Sent: 0</span></div>
      <div class="gui-tabs">
        <div class="gui-tab active" data-tab="main">Main</div>
        <div class="gui-tab" data-tab="settings">Settings</div>
      </div>
      <div class="gui-page active" data-page="main">
        <label>Message (editable anytime)</label>
        <textarea id="thundr-auto-msg" placeholder="Type your message...">${(FALLBACK_MESSAGE || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")}</textarea>
        <div class="gui-toggle">
          <span>Repeat after cycle</span>
          <label class="toggle-switch">
            <input type="checkbox" id="thundr-auto-repeat" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="gui-buttons">
          <button class="btn-start" id="thundr-auto-start">Start</button>
          <button class="btn-stop" id="thundr-auto-stop">Stop</button>
        </div>
      </div>
      <div class="gui-page" data-page="settings">
        <div class="slider-row">
          <div class="slider-label"><span>Delay after typing</span><span class="slider-val" id="val-input">${DELAY_AFTER_INPUT_MS}ms</span></div>
          <input type="range" id="slider-input" min="100" max="3000" step="100" value="${DELAY_AFTER_INPUT_MS}">
        </div>
        <div class="slider-row">
          <div class="slider-label"><span>Delay after send</span><span class="slider-val" id="val-send">${DELAY_AFTER_SEND}ms</span></div>
          <input type="range" id="slider-send" min="100" max="3000" step="100" value="${DELAY_AFTER_SEND}">
        </div>
        <div class="slider-row">
          <div class="slider-label"><span>Delay after skip</span><span class="slider-val" id="val-skip">${DELAY_AFTER_SKIP}ms</span></div>
          <input type="range" id="slider-skip" min="200" max="5000" step="100" value="${DELAY_AFTER_SKIP}">
        </div>
        <div class="slider-row">
          <div class="slider-label"><span>Wait for next user</span><span class="slider-val" id="val-wait">${WAIT_FOR_NEXT_USER_MS}ms</span></div>
          <input type="range" id="slider-wait" min="1000" max="15000" step="500" value="${WAIT_FOR_NEXT_USER_MS}">
        </div>
      </div>
    `;

    guiMessageEl = panel.querySelector("#thundr-auto-msg");
    guiRepeatEl = panel.querySelector("#thundr-auto-repeat");
    const startBtn = panel.querySelector("#thundr-auto-start");
    const stopBtn = panel.querySelector("#thundr-auto-stop");

    startBtn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      log("Start button clicked");
      startBtn.disabled = true;
      stopBtn.disabled = false;
      try {
        runLoop();
      } catch (err) {
        log("Error: " + err.message);
        console.error(err);
        resetGuiButtons();
      }
    }, true);
    stopBtn.addEventListener("click", () => {
      stopThundrAuto();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });
    stopBtn.disabled = true;

    // Tabs
    const tabs = panel.querySelectorAll(".gui-tab");
    const pages = panel.querySelectorAll(".gui-page");
    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        pages.forEach((p) => p.classList.remove("active"));
        tab.classList.add("active");
        panel.querySelector('.gui-page[data-page="' + tab.dataset.tab + '"]').classList.add("active");
      });
    });

    // Speed sliders
    function bindSlider(sliderId, valId, setter) {
      const slider = panel.querySelector("#" + sliderId);
      const valEl = panel.querySelector("#" + valId);
      if (!slider || !valEl) return;
      slider.addEventListener("input", () => {
        const v = parseInt(slider.value, 10);
        valEl.textContent = v >= 1000 ? (v / 1000).toFixed(1) + "s" : v + "ms";
        setter(v);
      });
    }
    bindSlider("slider-input", "val-input", (v) => { DELAY_AFTER_INPUT_MS = v; });
    bindSlider("slider-send",  "val-send",  (v) => { DELAY_AFTER_SEND = v; });
    bindSlider("slider-skip",  "val-skip",  (v) => { DELAY_AFTER_SKIP = v; });
    bindSlider("slider-wait",  "val-wait",  (v) => { WAIT_FOR_NEXT_USER_MS = v; });

    // Draggable
    const header = panel.querySelector(".gui-header");
    let isDragging = false, startX, startY, startLeft, startTop;
    header.addEventListener("mousedown", (e) => {
      if (e.target.tagName === "BUTTON") return;
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      const rect = panel.getBoundingClientRect();
      startLeft = rect.left;
      startTop = rect.top;
      panel.style.left = startLeft + "px";
      panel.style.top = startTop + "px";
      panel.style.right = "auto";
    });
    document.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      panel.style.left = (startLeft + e.clientX - startX) + "px";
      panel.style.top = (startTop + e.clientY - startY) + "px";
    });
    document.addEventListener("mouseup", () => { isDragging = false; });

    document.body.appendChild(panel);
    log("GUI ready. Edit message and click Start.");
  }

  createGUI();
})();
